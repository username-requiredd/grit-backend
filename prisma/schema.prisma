generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String  @id @unique
  email              String  @unique
  name               String?
  avatarUrl          String?

  ownedWorkspaces    Workspace[]
  memberWorkspaces   WorkspaceMember[]
  boardsOwned        Board[]           @relation("BoardOwner")
  cardsCreated       Card[]            @relation("CardCreator")
  comments           Comment[]
  cardAssignments    CardAssignee[]
}

model Workspace {
  id                 String   @id @default(uuid())
  title              String
  slug               String   @unique
  ownerId            String
  owner              User     @relation(fields: [ownerId], references: [id])

  boards             Board[]
  members            WorkspaceMember[]

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model WorkspaceMember {
  id                 String   @id @default(uuid())
  userId             String
  workspaceId        String
  role               Role     @default(MEMBER)

  user               User      @relation(fields: [userId], references: [id])
  workspace          Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([userId, workspaceId])
}

model Board {
  id                 String          @id @default(uuid())
  title              String
  slug               String?         @unique
  description        String?
  backgroundUrl      String?
  archived           Boolean         @default(false)
  visibility         BoardVisibility @default(PRIVATE)

  workspaceId        String
  workspace          Workspace       @relation(fields: [workspaceId], references: [id])

  ownerId            String
  owner              User            @relation("BoardOwner", fields: [ownerId], references: [id])

  columns            Column[]
  labels             Label[]

  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
}

model Column {
  id                 String   @id @default(uuid())
  boardId            String
  title              String
  position           Int
  isFinal            Boolean  @default(false)

  board              Board    @relation(fields: [boardId], references: [id])
  cards              Card[]

  @@unique([boardId, position])
}

model Card {
  id                 String   @id @default(uuid())
  columnId           String
  title              String
  description        String?
  position           Int
  dueDate            DateTime?
  archived           Boolean  @default(false)

  column             Column   @relation(fields: [columnId], references: [id])

  creatorId          String
  creator            User     @relation("CardCreator", fields: [creatorId], references: [id])

  labels             CardLabel[]
  assignees          CardAssignee[]
  comments           Comment[]

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([columnId, position])
}

model CardAssignee {
  id                 String   @id @default(uuid())
  cardId             String
  userId             String

  card               Card     @relation(fields: [cardId], references: [id])
  user               User     @relation(fields: [userId], references: [id])

  @@unique([cardId, userId])
}

model Label {
  id                 String   @id @default(uuid())
  boardId            String
  name               String
  color              String

  board              Board    @relation(fields: [boardId], references: [id])
  cards              CardLabel[]
  
  @@unique([boardId, name])
}

model CardLabel {
  id                 String   @id @default(uuid())
  cardId             String
  labelId            String

  card               Card     @relation(fields: [cardId], references: [id])
  label              Label    @relation(fields: [labelId], references: [id])

  @@unique([cardId, labelId])
}

model Comment {
  id                 String   @id @default(uuid())
  cardId             String
  userId             String
  text               String

  card               Card     @relation(fields: [cardId], references: [id])
  user               User     @relation(fields: [userId], references: [id])

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

enum Role {
  ADMIN
  MEMBER
  GUEST
}

enum BoardVisibility {
  PRIVATE
  WORKSPACE
  PUBLIC
}